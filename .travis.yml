dist: xenial

language: cpp
compiler:
 - gcc


addons:
  apt:
    config:
      retries: true
    packages:
    - autoconf
    - automake
    - cmake
    - g++
    - git
    - libbz2-dev
    - libsnappy-dev
    - libssl-dev
    - libtool
    - make
    - pkg-config
    - python3
    - python3-jinja2
    - libboost-chrono-dev
    - libboost-context-dev
    - libboost-coroutine-dev
    - libboost-date-time-dev
    - libboost-filesystem-dev
    - libboost-iostreams-dev
    - libboost-locale-dev
    - libboost-program-options-dev
    - libboost-serialization-dev
    - libboost-signals-dev
    - libboost-system-dev
    - libboost-test-dev
    - libboost-thread-dev
    - lcov

before_install:
  - gem install mtime_cache

jobs:
  include:
  - stage: prepare cache
    script:
      - |
        if timeout 1800 sh ciscripts/compiletest.sh ; then build/tests/chain_test && build/tests/plugin_test && sh ciscripts/collectcoverage.sh && wget -O - https://codecov.io/bash | bash  || echo "Codecov did not collect coverage reports" ; fi
        true

cache:
  timeout: 1800
  directories:
  - build
  - .mtime_cache
  - .ccache

before_cache:
- du -hs build/* | sort -nr | head
- find build -type f -ls | sort -k 7 -r -n | head -5
- rm -rf ./**/*.gcov
